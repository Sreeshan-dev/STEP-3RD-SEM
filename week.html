<script>
  const cfg = {
    USER: "Sreeshan-dev",   // GitHub username
    REPO: "STEP-3RD-SEM",   // Repository name
    BRANCH: "main"          // Branch name
  };

  const params = new URLSearchParams(location.search);
  const DIR = params.get('dir') || params.get('week') || 'Week1';
  const SUB = params.get('sub') || null;
  document.getElementById('title').textContent = DIR + (SUB ? ' / ' + SUB : '');

  async function listDir(pathParts) {
    const path = pathParts.map(encodeURIComponent).join('/');
    const apiUrl = `https://api.github.com/repos/${cfg.USER}/${cfg.REPO}/contents/${path}?ref=${cfg.BRANCH}`;
    try {
      const res = await fetch(apiUrl);
      const items = await res.json();
      if (!Array.isArray(items)) throw new Error('No array');
      return items;
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  function makeGitHubTreeUrl(parts) {
    return `https://github.com/${cfg.USER}/${cfg.REPO}/tree/${cfg.BRANCH}/` + parts.map(encodeURIComponent).join('/');
  }

  async function render() {
    const listEl = document.getElementById('contents');
    listEl.innerHTML = '';
    const pathParts = [DIR];
    const items = await listDir(pathParts);
    if (!items) {
      listEl.innerHTML = '<li class="muted">Could not load contents. Is the repo public and Pages enabled?</li>';
      return;
    }

    if (!SUB) {
      const dirs = items.filter(i=>i.type==='dir');
      const files = items.filter(i=>i.type==='file');

      if (dirs.length === 0 && files.length === 0) {
        listEl.innerHTML = '<li class="muted">Folder is empty.</li>'; return;
      }

      dirs.forEach(d => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.textContent = d.name + '/';
        a.href = `week.html?dir=${encodeURIComponent(DIR)}&sub=${encodeURIComponent(d.name)}`;
        li.appendChild(a);
        const gh = document.createElement('a');
        gh.href = makeGitHubTreeUrl([DIR, d.name]);
        gh.textContent = ' (GitHub)';
        gh.className = 'small'; gh.target = '_blank';
        li.appendChild(gh);
        listEl.appendChild(li);
      });

      files.forEach(f => {
        const li = document.createElement('li');
        const a = document.createElement('a'); a.href = '#'; a.textContent = f.name;
        a.addEventListener('click', (e)=>{ e.preventDefault(); previewFile(f); });
        li.appendChild(a);
        const raw = document.createElement('a'); raw.href = f.download_url; raw.textContent = ' raw'; raw.className='small'; raw.target='_blank';
        li.appendChild(raw);
        listEl.appendChild(li);
      });
    } else {
      const items2 = await listDir([DIR, SUB]);
      if (!items2) { listEl.innerHTML = '<li class="muted">Unable to read subfolder.</li>'; return; }
      const files = items2.filter(i=>i.type==='file');
      const dirs = items2.filter(i=>i.type==='dir');

      const backLi = document.createElement('li');
      backLi.innerHTML = `<a href="week.html?dir=${encodeURIComponent(DIR)}">‚Üê Back to ${DIR}</a>`;
      listEl.appendChild(backLi);

      if (files.length === 0 && dirs.length === 0) {
        listEl.innerHTML += '<li class="muted">No files here.</li>';
      } else {
        dirs.forEach(d => {
          const li = document.createElement('li');
          const a = document.createElement('a');
          a.textContent = d.name + '/';
          a.href = `week.html?dir=${encodeURIComponent(DIR)}&sub=${encodeURIComponent(SUB + '/' + d.name)}`;
          li.appendChild(a);
          const gh = document.createElement('a'); gh.href = makeGitHubTreeUrl([DIR, SUB, d.name]); gh.textContent=' (GitHub)'; gh.className='small'; gh.target='_blank';
          li.appendChild(gh);
          listEl.appendChild(li);
        });

        files.forEach(f => {
          const li = document.createElement('li');
          const a = document.createElement('a'); a.href='#'; a.textContent = f.name;
          a.addEventListener('click',(e)=>{ e.preventDefault(); previewFile(f); });
          li.appendChild(a);
          const raw = document.createElement('a'); raw.href=f.download_url; raw.textContent=' raw'; raw.className='small'; raw.target='_blank';
          li.appendChild(raw);
          listEl.appendChild(li);
        });
      }
    }
  }

  async function previewFile(file) {
    const viewer = document.getElementById('viewer');
    const pathInfo = document.getElementById('pathinfo');
    const filePath = (SUB ? `${DIR}/${SUB}/${file.name}` : `${DIR}/${file.name}`);
    pathInfo.textContent = filePath;
    try {
      const res = await fetch(file.download_url);
      const text = await res.text();
      viewer.textContent = text;
    } catch (e) {
      viewer.innerHTML = '<span class="muted">Could not preview file. Use the raw link to open/download.</span>';
    }
  }

  render();
</script>
